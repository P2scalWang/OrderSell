<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Order Sell - ‡∏ï‡∏±‡∏î‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</title>
  <style>
    :root{
      --brand:#ff3b30; --muted:#f6f7fb; --text:#222; --border:#e6e8ef;
    }
    *{box-sizing:border-box}
    body{font-family:system-ui,Segoe UI,Roboto,TH Sarabun New,sans-serif;background:#fff;margin:0;color:var(--text)}
    .wrap{max-width:920px;margin:24px auto;padding:0 16px}
    .card{background:#fff;border:1px solid var(--border);border-radius:14px;box-shadow:0 2px 12px rgba(0,0,0,.04);margin-bottom:16px;position:relative}
    .head{background:linear-gradient(90deg,#ff3b30,#ff6a59);color:#fff;padding:18px 16px}
    .head h1{font-size:20px;margin:0}
    .body{padding:16px}
    label{display:block;font-weight:600;margin:14px 0 6px}
    input[type="number"],input[type="text"],select{
      width:100%;padding:10px 12px;border:1px solid var(--border);border-radius:10px;outline:none
    }
    input[type="number"]:focus,select:focus,input[type="text"]:focus{border-color:#ffb6b6;box-shadow:0 0 0 4px #ffe9e9}
    .row{display:grid;gap:12px}
    @media(min-width:720px){ .row{grid-template-columns: 1.2fr 1fr}}
    .selected{font-size:13px;color:#ff3b30;margin-top:8px}
    .divider{height:1px;background:var(--border);margin:14px 0}
    button{background:var(--brand);color:#fff;border:none;border-radius:10px;padding:12px 16px;font-size:16px;cursor:pointer}
    button:disabled{opacity:.6;cursor:not-allowed}
    .pill{display:inline-block;background:#ffeef0;color:#ff3b30;border:1px solid #ffd6d6;border-radius:999px;padding:4px 10px;font-size:12px}
    .success{background:#f0fff4;border:1px solid #c7f0d2;color:#146c2e;padding:10px;border-radius:10px}
    .error{background:#fff5f5;border:1px solid #ffd6d6;color:#b42318;padding:10px;border-radius:10px}
    .remove-btn{background:#e74c3c;margin-top:10px}
    .invalid{border-color:#ff8a8a !important;box-shadow:0 0 0 3px rgba(255,0,0,.12) !important}
    .item-title{font-weight:700;margin:6px 0 10px;color:#ff3b30}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="head">
        <h1>Order Sell - ‡∏ï‡∏±‡∏î‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h1>
        <div class="pill">‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏à‡∏≤‡∏Å Google Sheet</div>
      </div>
      <div class="body">
        <!-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡πâ‡∏≤‡∏ô -->
        <label>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡πâ‡∏≤‡∏ô</label>
        <select id="shopSelect" disabled required>
          <option value="">‚Äî ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏£‡πâ‡∏≤‡∏ô ‚Äî</option>
        </select>

        <!-- ‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á -->
        <label style="margin-top:12px;">‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á</label>
        <input id="docRef" type="text" placeholder="‡πÄ‡∏ä‡πà‡∏ô SO01234" required />

        <div class="divider"></div>

        <div id="items-container"></div>
        <button style="margin-top:8px" onclick="addItem()">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</button>
        <div class="divider"></div>
        <button id="btnSubmit" disabled>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
        <div id="result" style="margin-top:12px"></div>
      </div>
    </div>
  </div>

  <script>
    const SPREADSHEET_ID = "1I9jAyU7UHXxbizMxpT5RghoyfnnYkBPetS39hS1BzH0";
    const SHEET_NAME = "ListItem";
    const COMPANY_SHEET = "CompanyName";
    const WEBHOOK_URL = "https://n8n-p2sw2ng.p2scalw2ng.xyz/webhook-test/OrderSell";
    let productList = [];
    let shopList = [];

    async function fetchListItems(sheet){
      const url = `https://docs.google.com/spreadsheets/d/${SPREADSHEET_ID}/gviz/tq?tqx=out:json&sheet=${encodeURIComponent(sheet)}`;
      const res = await fetch(url);
      const text = await res.text();
      const jsonStr = text.substring(text.indexOf("{"), text.lastIndexOf("}") + 1);
      const data = JSON.parse(jsonStr);
      return (data.table.rows || [])
        .map(r => {
          const c = r.c || [];
          return c.map(cc => (cc ? (cc.f ?? String(cc.v ?? "")).trim() : ""));
        });
    }

    async function loadProducts(){
      const rows = await fetchListItems(SHEET_NAME);
      return rows.map(r=>({sku:r[0], name:r[1]}))
                 .filter(x=>x.sku && x.name && x.sku.toLowerCase()!=="sku");
    }

    async function loadShops(){
      const rows = await fetchListItems(COMPANY_SHEET);
      return rows.map(r=>({shop:r[0]}))
                 .filter(x=>x.shop && x.shop.toLowerCase()!=="‡∏£‡πâ‡∏≤‡∏ô");
    }

    function buildItemBlock(){
      const div = document.createElement('div');
      div.className = 'card';
      div.innerHTML = `
        <div class="body">
          <div class="item-title"></div>
          <label>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</label>
          <select class="product" required>
            <option value="">‚Äî ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ ‚Äî</option>
          </select>
          <div class="selected selectedInfo" style="display:none"></div>
          <div class="row">
            <div>
              <label>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</label>
              <input class="qty" type="number" min="1" step="1" placeholder="‡πÄ‡∏ä‡πà‡∏ô 5" required />
            </div>
            <div>
              <label>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)</label>
              <input class="note" type="text" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏Ç‡∏≤‡∏¢‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤, ‡∏•‡∏î‡∏™‡∏ï‡πá‡∏≠‡∏Å" />
            </div>
          </div>
          <button class="remove-btn" onclick="this.closest('.card').remove();renumberItems();checkBtnSubmit()">‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ</button>
        </div>
      `;
      return div;
    }

    function fillProductOptions(select){
      select.innerHTML = `<option value="">‚Äî ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ ‚Äî</option>`;
      productList.forEach(r=>{
        const opt=document.createElement('option');
        opt.value=r.sku;
        opt.dataset.name=r.name;
        opt.textContent=`${r.name} ‚Äî ${r.sku}`;
        select.appendChild(opt);
      });
      select.disabled = productList.length===0;
    }

    function addItem(){
      const container = document.getElementById('items-container');
      const block = buildItemBlock();
      container.appendChild(block);
      const select = block.querySelector('.product');
      fillProductOptions(select);
      select.addEventListener('change',()=>{
        const name=select.selectedOptions[0]?.dataset?.name||"";
        const selInfo=block.querySelector('.selectedInfo');
        if(select.value){
          selInfo.style.display='block';
          selInfo.textContent=`‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß: ${name} (‡∏£‡∏´‡∏±‡∏™: ${select.value})`;
        }else selInfo.style.display='none';
        checkBtnSubmit();
      });
      renumberItems();
      checkBtnSubmit();
    }

    function renumberItems(){
      document.querySelectorAll('#items-container .card .item-title')
        .forEach((el, idx)=> el.textContent = `‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà ${idx+1}`);
    }

    function validateForm(showErrors=false){
      let ok=true;
      const errs=[];
      const resultDiv=document.getElementById('result');
      document.querySelectorAll('.invalid').forEach(el=>el.classList.remove('invalid'));

      const shop=document.getElementById('shopSelect');
      const docRef=document.getElementById('docRef');
      if(!shop.value){ok=false;errs.push('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤ "‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡πâ‡∏≤‡∏ô"'); if(showErrors) shop.classList.add('invalid');}
      if(!docRef.value.trim()){ok=false;errs.push('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å "‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á"'); if(showErrors) docRef.classList.add('invalid');}

      const blocks=[...document.querySelectorAll('#items-container .card')];
      if(blocks.length===0){ok=false;errs.push('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£');}
      else{
        blocks.forEach((b,idx)=>{
          const prod=b.querySelector('.product');
          const qty=b.querySelector('.qty');
          const val=parseInt(qty.value||"0",10);
          if(!prod.value){ok=false;errs.push(`‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà ${idx+1}: ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤`); if(showErrors) prod.classList.add('invalid');}
          if(!(val>=1)){ok=false;errs.push(`‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà ${idx+1}: ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1`); if(showErrors) qty.classList.add('invalid');}
        });
      }

      if(showErrors && errs.length){resultDiv.innerHTML=`<div class="error">${errs.join("<br>")}</div>`;}
      else if(showErrors){resultDiv.innerHTML="";}
      return ok;
    }

    function checkBtnSubmit(){
      document.getElementById('btnSubmit').disabled=!validateForm(false);
    }

    async function submitPayload(){
      if(!validateForm(true))return;
      const shop=document.getElementById('shopSelect').value;
      const docRef=document.getElementById('docRef').value;
      const payloads=[...document.querySelectorAll('#items-container .card')].map(b=>{
        const s=b.querySelector('.product');
        const sku=s.value;
        const name=s.selectedOptions[0]?.dataset?.name||"";
        const qty=parseInt(b.querySelector('.qty').value||"0",10);
        const note=b.querySelector('.note').value;
        return{action:"order_sell",shop,doc_ref:docRef,sku,name,qty:-Math.abs(qty),note,timestamp_iso:new Date().toISOString()};
      }).filter(x=>x.sku);
      const resultDiv=document.getElementById('result');
      try{
        const resp=await fetch(WEBHOOK_URL,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(payloads)});
        const text=await resp.text();
        let respJson={};try{respJson=JSON.parse(text);}catch{}
        resultDiv.innerHTML=`<div class="success">‡∏™‡πà‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à üéâ<br><pre>${JSON.stringify(respJson||text,null,2)}</pre></div>`;
      }catch(err){resultDiv.innerHTML=`<div class="error">‡∏™‡πà‡∏á‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${err.message}</div>`;}
    }

    document.getElementById('btnSubmit').addEventListener('click',submitPayload);

    (async function init(){
      productList=await loadProducts();
      shopList=await loadShops();
      const shopSelect=document.getElementById('shopSelect');
      shopSelect.innerHTML=`<option value="">‚Äî ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡πâ‡∏≤‡∏ô ‚Äî</option>`;
      shopList.forEach(s=>{
        const opt=document.createElement('option');
        opt.value=s.shop; opt.textContent=s.shop;
        shopSelect.appendChild(opt);
      });
      shopSelect.disabled=shopList.length===0;
      shopSelect.addEventListener('change',checkBtnSubmit);
      docRef.addEventListener('input',checkBtnSubmit);
      addItem();
    })();
  </script>
</body>
</html>
