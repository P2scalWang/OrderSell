<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡πÇ‡∏£‡∏Ñ‡πÑ‡∏ï (Real-time)</title>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600&display=swap" rel="stylesheet">
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <style>
        :root { --primary: #007bff; --danger: #dc3545; --warning: #ffc107; --success: #28a745; --bg: #f4f6f9; --card-bg: #ffffff; --text-dark: #333; --text-grey: #666; }
        body { font-family: 'Sarabun', sans-serif; background-color: var(--bg); margin: 0; padding: 20px; color: var(--text-dark); }
        .container { max-width: 1200px; margin: 0 auto; background-color: var(--bg); }
        
        /* Header */
        header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; gap: 15px; }
        h1 { margin: 0; font-size: 1.5rem; color: var(--primary); }
        .header-controls { display: flex; gap: 10px; align-items: center; }

        /* Buttons */
        .btn-pdf { background-color: #dc3545; color: white; border: none; padding: 8px 16px; border-radius: 50px; cursor: pointer; font-family: 'Sarabun'; font-weight: bold; display: flex; align-items: center; gap: 5px; transition: 0.3s; white-space: nowrap; }
        .btn-pdf:hover { background-color: #c82333; box-shadow: 0 4px 8px rgba(220,53,69,0.3); }
        .filter-group { display: flex; gap: 5px; background: #fff; padding: 5px; border-radius: 50px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .btn-filter { border: none; background: transparent; padding: 8px 16px; border-radius: 50px; cursor: pointer; font-family: 'Sarabun'; font-weight: 600; color: var(--text-grey); transition: 0.3s; white-space: nowrap; }
        .btn-filter.active { background: var(--primary); color: white; box-shadow: 0 2px 5px rgba(0,123,255,0.4); }

        /* Layout Desktop */
        .grid-cards { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 20px; }
        .card { background: var(--card-bg); padding: 15px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); text-align: center; position: relative; overflow: hidden; }
        .card::before { content: ''; position: absolute; top: 0; left: 0; width: 6px; height: 100%; }
        .card.weight::before { background: var(--warning); }
        .card.dialysis::before { background: var(--primary); }
        .card.sugar::before { background: var(--danger); }
        .card h3 { margin: 0 0 5px; font-size: 0.9rem; color: var(--text-grey); font-weight: 500; }
        .card .value { font-size: 2rem; font-weight: 700; color: var(--text-dark); }
        .card .unit { font-size: 0.8rem; color: #999; }
        .status-badge { display: inline-block; padding: 4px 12px; border-radius: 20px; font-size: 1rem; font-weight: bold; }
        .status-have { background: #d4edda; color: #155724; }
        .status-none { background: #f8d7da; color: #721c24; }
        
        .chart-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .chart-box { background: white; padding: 15px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        .chart-box h3 { margin-top: 0; margin-bottom: 10px; font-size: 1rem; color: var(--text-grey); }
        #loading { text-align: center; padding: 40px; }

        /* Mobile Styles */
        @media (max-width: 768px) {
            body { padding: 10px; }
            header { flex-direction: column; align-items: stretch; gap: 10px; }
            h1 { text-align: center; font-size: 1.3rem; }
            .header-controls { flex-direction: column; width: 100%; }
            .filter-group { width: 100%; justify-content: space-between; overflow-x: auto; }
            .btn-filter { flex: 1; padding: 8px 10px; font-size: 0.9rem; }
            .btn-pdf { width: 100%; justify-content: center; margin-top: 5px; }
            .grid-cards { grid-template-columns: 1fr; gap: 10px; }
            .card { display: flex; align-items: center; justify-content: space-between; padding: 15px 20px; text-align: left; }
            .card h3 { margin: 0; }
            .card .value { font-size: 1.5rem; }
            .chart-grid { grid-template-columns: 1fr; gap: 15px; }
            .chart-container-height { height: 250px !important; }
            #bp-container { height: 250px !important; }
        }

        /* ========================================================= */
        /* üü° PDF FORCE DESKTOP MODE (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÉ‡∏´‡∏°‡πà ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡∏Å‡∏£‡∏≤‡∏ü) */
        /* ========================================================= */
        body.pdf-mode {
            width: 1200px !important;
            min-width: 1200px !important;
            background-color: white !important;
            padding: 20px !important;
            margin: 0 !important;
            overflow: visible !important;
        }

        body.pdf-mode .container {
            width: 100% !important;
            max-width: 1200px !important;
            padding: 0 !important;
            margin: 0 !important;
        }

        /* ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö Layout ‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô‡πÅ‡∏ö‡∏ö Desktop */
        body.pdf-mode header { flex-direction: row !important; }
        body.pdf-mode .grid-cards { grid-template-columns: repeat(3, 1fr) !important; gap: 15px !important; }
        body.pdf-mode .card { display: block !important; text-align: center !important; }
        body.pdf-mode .chart-grid { grid-template-columns: 1fr 1fr !important; gap: 15px !important; }

        body.pdf-mode .chart-box {
            width: auto !important;
            flex: none !important;
        }
        
        body.pdf-mode #bp-container { height: 280px !important; width: 1100px !important; }
        body.pdf-mode .chart-container-height { height: 220px !important; width: 520px !important; }
    </style>
</head>
<body>

<div id="capture-area">
    <div class="container">
        <header>
            <h1>üè• ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡πÑ‡∏ï</h1>
            <div class="header-controls">
                <div class="filter-group" id="controls-filter">
                    <button id="btn-7" class="btn-filter" onclick="updateDashboard('7')">7 ‡∏ß‡∏±‡∏ô</button>
                    <button id="btn-15" class="btn-filter" onclick="updateDashboard('15')">15 ‡∏ß‡∏±‡∏ô</button>
                    <button id="btn-30" class="btn-filter" onclick="updateDashboard('30')">30 ‡∏ß‡∏±‡∏ô</button>
                    <button id="btn-all" class="btn-filter active" onclick="updateDashboard('all')">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
                </div>
                <button id="btn-export" class="btn-pdf" onclick="exportPDF()">üì• PDF</button>
            </div>
        </header>

        <div id="loading">‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î...</div>

        <div id="dashboard-content" style="display:none;">
            <div class="grid-cards">
                <div class="card weight">
                    <div><h3>‚öñÔ∏è ‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å</h3><span class="unit">‡∏Å‡∏¥‡πÇ‡∏•‡∏Å‡∏£‡∏±‡∏°</span></div>
                    <div id="disp-weight" class="value">-</div>
                </div>
                <div class="card dialysis">
                    <div><h3>ü©∏ ‡πÄ‡∏™‡πâ‡∏ô‡∏ü‡∏≠‡∏Å‡πÑ‡∏ï</h3><span class="unit">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</span></div>
                    <div id="disp-line" class="status-badge">-</div>
                </div>
                <div class="card sugar">
                    <div><h3>üç¨ ‡∏ô‡πâ‡∏≥‡∏ï‡∏≤‡∏•</h3><span class="unit">mg/dL</span></div>
                    <div id="disp-sugar" class="value">-</div>
                </div>
            </div>

            <div class="chart-grid">
                <div class="chart-box" style="grid-column: 1 / -1;">
                    <h3>üìà ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏±‡∏ô‡πÇ‡∏•‡∏´‡∏¥‡∏ï ‡πÅ‡∏•‡∏∞ ‡∏ä‡∏µ‡∏û‡∏à‡∏£</h3>
                    <div id="bp-container" style="position: relative; height: 250px; width: 100%;">
                        <canvas id="bpChart"></canvas>
                    </div>
                </div>
                <div class="chart-box">
                    <h3>üìâ ‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏°‡∏ô‡πâ‡∏≥‡∏ï‡∏≤‡∏•</h3>
                    <div class="chart-container-height" style="position: relative; height: 200px; width: 100%;">
                        <canvas id="sugarChart"></canvas>
                    </div>
                </div>
                <div class="chart-box">
                    <h3>‚öñÔ∏è ‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏°‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å</h3>
                    <div class="chart-container-height" style="position: relative; height: 200px; width: 100%;">
                        <canvas id="weightChart"></canvas>
                    </div>
                </div>
            </div>
            
            <div id="print-date" style="display:none; text-align: right; color: #999; margin-top: 10px; font-size: 0.8rem;"></div>
        </div>
    </div>
</div>

<script>
    // üî¥ ‡πÉ‡∏™‡πà‡∏•‡∏¥‡∏á‡∏Å‡πå CSV ‡πÉ‡∏´‡∏°‡πà‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ (‡∏ú‡∏°‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÉ‡∏´‡πâ‡πÅ‡∏•‡πâ‡∏ß)
    const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vS6joLS4GAuu3gDN9KrSVMfLYn6snVN4W26iZCiyCHf4jhy6LlCEvIyW210aUYFOsQvHUlJpLPpbZqw/pub?output=csv';

    let rawData = [];
    let chartBP, chartSugar, chartWeight;

    window.onload = function() { fetchData(); };

    function fetchData() {
        // üî¥ ‡πÄ‡∏ó‡∏Ñ‡∏ô‡∏¥‡∏Ñ‡∏û‡∏¥‡πÄ‡∏®‡∏©: ‡πÄ‡∏ï‡∏¥‡∏° &t=‡πÄ‡∏ß‡∏•‡∏≤‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏´‡∏°‡πà ‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏ï‡∏¥‡∏î Cache
        const bustCacheUrl = CSV_URL + '&t=' + new Date().getTime();

        Papa.parse(bustCacheUrl, {
            download: true, header: true, 
            complete: function(results) {
                rawData = results.data
                    .filter(row => row['Time'] && row['Time'].trim() !== '') 
                    .map(row => ({
                        date: row['Time'],
                        bp_sys: parseFloat(row['bp_sys']),
                        bp_dia: parseFloat(row['bp_dia']),
                        pulse: parseFloat(row['‡∏ä‡∏µ‡∏û‡∏à‡∏£']),
                        sugar: parseFloat(row['‡∏Ñ‡πà‡∏≤‡∏ô‡πâ‡∏≥‡∏ï‡∏≤‡∏•']),
                        weight: parseFloat(row['weight']),
                        line: row['dialysis_line']
                    }));
                document.getElementById('loading').style.display = 'none';
                document.getElementById('dashboard-content').style.display = 'block';
                updateDashboard('all'); 
            },
            error: function(err) { console.error('Error:', err); }
        });
    }

    function updateDashboard(range) {
        document.querySelectorAll('.btn-filter').forEach(btn => btn.classList.remove('active'));
        document.getElementById('btn-' + range).classList.add('active');
        renderCards();
        let chartData = [...rawData];
        if (range === '7') chartData = chartData.slice(-7);
        else if (range === '15') chartData = chartData.slice(-15);
        else if (range === '30') chartData = chartData.slice(-30);
        renderCharts(chartData);
    }

    function renderCards() {
        if (rawData.length === 0) return;
        const latest = rawData[rawData.length - 1];
        document.getElementById('disp-weight').innerText = latest.weight || '-';
        document.getElementById('disp-sugar').innerText = latest.sugar || '-';
        const lineEl = document.getElementById('disp-line');
        if (latest.line && latest.line.toLowerCase().includes('have')) {
            lineEl.innerText = "‚úî ‡∏°‡∏µ"; lineEl.className = "status-badge status-have";
        } else {
            lineEl.innerText = "‚úñ ‡πÑ‡∏°‡πà‡∏°‡∏µ"; lineEl.className = "status-badge status-none";
        }
    }

    function renderCharts(data) {
        const labels = data.map(d => d.date);
        
        const flowAnimation = {
            duration: 1500, easing: 'easeOutQuart',
            delay: (context) => {
                let delay = 0;
                if (context.type === 'data' && context.mode === 'default') {
                    delay = context.dataIndex * 100;
                }
                return delay;
            }
        };

        const commonOptions = {
            responsive: true,
            maintainAspectRatio: false,
            interaction: { mode: 'index', intersect: false },
            plugins: { legend: { position: 'top', labels: { boxWidth: 12, usePointStyle: true } } },
            animations: { y: { easing: 'easeOutQuart', duration: 1000 } }
        };

        if(chartBP) chartBP.destroy();
        chartBP = new Chart(document.getElementById('bpChart').getContext('2d'), {
            type: 'line',
            data: {
                labels: labels,
                datasets: [
                    { label: 'Sys', data: data.map(d=>d.bp_sys), borderColor: '#dc3545', backgroundColor: '#dc3545', tension: 0.4, pointRadius: 3, borderWidth: 2 },
                    { label: 'Dia', data: data.map(d=>d.bp_dia), borderColor: '#ffc107', backgroundColor: '#ffc107', tension: 0.4, pointRadius: 3, borderWidth: 2 },
                    { label: 'Pulse', data: data.map(d=>d.pulse), borderColor: '#28a745', backgroundColor: '#28a745', borderDash: [5,5], tension: 0.4, pointRadius: 3, borderWidth: 2 }
                ]
            },
            options: { ...commonOptions, animation: flowAnimation }
        });

        if(chartSugar) chartSugar.destroy();
        chartSugar = new Chart(document.getElementById('sugarChart').getContext('2d'), {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{ label: 'Sugar', data: data.map(d=>d.sugar), backgroundColor: 'rgba(54, 162, 235, 0.7)', borderRadius: 4 }]
            },
            options: { ...commonOptions, animation: { duration: 1000, easing: 'easeOutQuart' } }
        });

        if(chartWeight) chartWeight.destroy();
        chartWeight = new Chart(document.getElementById('weightChart').getContext('2d'), {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{ label: 'Weight', data: data.map(d=>d.weight), borderColor: '#ff9f40', backgroundColor: 'rgba(255, 159, 64, 0.2)', fill: true, tension: 0.4, pointRadius: 4, borderWidth: 2 }]
            },
            options: { ...commonOptions, animation: flowAnimation }
        });
    }

    function exportPDF() {
        const body = document.body;
        const filters = document.getElementById('controls-filter');
        const btnExport = document.getElementById('btn-export');
        const printDate = document.getElementById('print-date');
        const element = document.getElementById('capture-area');

        window.scrollTo(0, 0);

        body.classList.add('pdf-mode');
        filters.style.display = 'none';
        btnExport.style.display = 'none';
        printDate.innerText = '‡∏û‡∏¥‡∏°‡∏û‡πå‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô: ' + new Date().toLocaleString('th-TH');
        printDate.style.display = 'block';

        setTimeout(() => {
            chartBP.resize(); 
            chartSugar.resize(); 
            chartWeight.resize();

            const opt = { 
                margin: 0.2, 
                filename: '‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û.pdf', 
                image: { type: 'jpeg', quality: 0.98 }, 
                html2canvas: { 
                    scale: 2, 
                    useCORS: true,
                    windowWidth: 1200,
                    width: 1200
                }, 
                jsPDF: { unit: 'in', format: 'a4', orientation: 'landscape' } 
            };
            
            html2pdf().set(opt).from(element).save().then(() => {
                body.classList.remove('pdf-mode');
                filters.style.display = 'flex';
                btnExport.style.display = 'flex';
                printDate.style.display = 'none';
                
                setTimeout(() => { 
                    chartBP.resize(); 
                    chartSugar.resize(); 
                    chartWeight.resize(); 
                }, 300);
            });
        }, 1000); 
    }
</script>

</body>
</html>
